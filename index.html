<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameVault Pro | Elite Gaming Store</title>
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome 6.4.0 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        :root {
            --accent-color: #00d2ff;
            --accent-gradient: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            --dark-bg: #0b0f19;
            --card-bg: #161c2d;
            --glass-bg: rgba(22, 28, 45, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --danger: #ff4d4d;
            --warning: #ffb86c;
            --success: #00f2fe;
        }

        body {
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 210, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(58, 123, 213, 0.05) 0%, transparent 40%);
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
        }

        h1, h2, h3, h4, .navbar-brand { font-family: 'Space Grotesk', sans-serif; }

        .navbar {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem 0;
            z-index: 1050;
        }

        .navbar-brand {
            font-weight: 800;
            letter-spacing: -1px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn-circle {
            width: 42px; height: 42px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-btn-circle:hover {
            background: var(--accent-color); border-color: var(--accent-color);
            transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .nav-btn-circle.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        .profile-switch {
            background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 4px;
            display: flex; border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-btn {
            border: none; background: transparent; color: var(--text-secondary);
            padding: 6px 16px; border-radius: 8px; font-size: 0.9rem;
            font-weight: 600; transition: all 0.25s ease;
        }

        .profile-btn.active {
            background: var(--accent-gradient); color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .cart-trigger {
            background: transparent; border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff !important; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; transition: all 0.3s; cursor: pointer;
        }

        .game-card {
            background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px; overflow: hidden; transition: all 0.3s ease;
        }

        .game-img-container { height: 180px; position: relative; background: #000; }
        .game-img-container img { width: 100%; height: 100%; object-fit: cover; }

        .platform-badge {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700;
        }

        .btn-buy { background: var(--accent-gradient); color: white; border: none; }

        .receipt-container {
            background: var(--card-bg); border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 650px; margin: 40px auto; padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            position: relative;
        }

        .qty-controls {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.05); border-radius: 8px; padding: 2px 8px;
        }
        .qty-btn {
            background: none; border: none; color: var(--accent-color);
            font-weight: bold; padding: 0 5px; cursor: pointer;
        }

        .form-control-custom {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white !important; padding: 12px 15px; border-radius: 12px;
        }
        .form-control-custom:focus {
            background: rgba(255,255,255,0.08); border-color: var(--accent-color);
            box-shadow: none;
        }

        #loader {
            position: fixed; inset: 0; background: var(--dark-bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-circle {
            width: 50px; height: 50px; border: 3px solid rgba(0, 210, 255, 0.1);
            border-top-color: var(--accent-color); border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-circle mb-4"></div>
    <div class="h5 fw-light">INICIALIZANDO GAMEVAULT...</div>
</div>

<nav class="navbar navbar-dark sticky-top">
    <div class="container">
        <div class="nav-controls me-3">
            <div id="global-back-btn" class="nav-btn-circle disabled" onclick="handleGlobalBack()" title="Volver">
                <i class="fa-solid fa-arrow-left"></i>
            </div>
            <div id="global-home-btn" class="nav-btn-circle" onclick="showHome()" title="Inicio">
                <i class="fa-solid fa-house"></i>
            </div>
        </div>

        <a class="navbar-brand d-none d-md-flex align-items-center" onclick="showHome()">
            <i class="fa-solid fa-bolt me-2 fs-4"></i> GAMEVAULT
        </a>

        <div class="d-flex align-items-center gap-3 ms-auto">
            <div id="profile-switcher-container" class="profile-switch">
                <button id="btn-user" class="profile-btn active" onclick="setProfile('user')">Tienda</button>
                <button id="btn-admin" class="profile-btn" onclick="setProfile('admin')">Gestión</button>
            </div>
            <button id="cart-btn-main" class="cart-trigger position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartPanel">
                <i class="fa-solid fa-cart-shopping"></i>
                <span id="cart-counter" class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" style="font-size: 0.65rem;">0</span>
            </button>
        </div>
    </div>
</nav>

<div id="main-content" class="container mt-5">
    <!-- View Normal -->
    <div id="view-normal">
        <div class="row align-items-end mb-5">
            <div class="col">
                <h2 id="view-title" class="fw-bold mb-1">Catálogo de Juegos</h2>
                <p id="view-desc" class="text-secondary mb-0">Títulos exclusivos para la comunidad Pro.</p>
            </div>
            <div id="admin-actions" class="col-auto d-none">
                <button class="btn btn-buy p-2 px-4 rounded-3" onclick="abrirModalCrear()">
                    <i class="fa-solid fa-plus me-2"></i>Nuevo Juego
                </button>
            </div>
        </div>
        <div id="admin-panel" style="display: none;">
            <div class="custom-table table-responsive">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                        <tr><th class="ps-4">Juego</th><th>Plataforma</th><th>Precio</th><th class="text-end pe-4">Acciones</th></tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>
        <div id="grid-productos" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4 pb-5"></div>
    </div>

    <!-- View Receipt -->
    <div id="view-receipt" style="display: none;">
        <div class="receipt-container">
            <div class="text-center mb-4 pt-3">
                <div class="display-4 text-info mb-2"><i class="fa-solid fa-receipt"></i></div>
                <h2 class="fw-bold">Resumen de Orden</h2>
                <div class="badge bg-dark text-info p-2 px-3 mt-2">ID: <span id="receipt-order-id"></span></div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-borderless small align-middle">
                    <thead>
                        <tr class="text-secondary border-bottom border-white border-opacity-10">
                            <th>Producto</th><th class="text-center">Cant.</th><th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items-list"></tbody>
                </table>
            </div>
            <div class="border-top border-white border-opacity-10 pt-3 mt-3">
                <div class="d-flex justify-content-between h4 fw-bold">
                    <span>Total a Pagar:</span>
                    <span class="text-info" id="receipt-total"></span>
                </div>
            </div>
            <div class="row g-2 mt-5">
                <div class="col-md-6">
                    <button class="btn btn-outline-info w-100 p-3 rounded-4 fw-bold" onclick="showHome()">CANCELAR</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-buy w-100 p-3 rounded-4 fw-bold" onclick="showCheckout()">IR AL PAGO <i class="fa-solid fa-credit-card ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Checkout -->
    <div id="view-checkout" style="display: none;">
        <div class="receipt-container">
            <div class="text-center mb-4 pt-3">
                <div class="display-4 mb-2" style="color: var(--accent-color)"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                <h2 class="fw-bold">Detalles de Facturación</h2>
                <p class="text-secondary">Complete sus datos para finalizar la compra</p>
            </div>

            <form id="checkoutForm">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">NOMBRE COMPLETO</label>
                    <input type="text" id="cust-name" class="form-control form-control-custom" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-secondary">CORREO ELECTRÓNICO</label>
                    <input type="email" id="cust-email" class="form-control form-control-custom" placeholder="juan@ejemplo.com" required>
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-secondary">DIRECCIÓN</label>
                    <textarea id="cust-address" class="form-control form-control-custom" rows="2" placeholder="Calle, Ciudad..." required></textarea>
                </div>
                <button type="submit" class="btn btn-buy w-100 p-3 rounded-4 fw-bold">CONFIRMAR PAGO</button>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="gameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 text-white">
            <div class="modal-header border-0 p-4 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">Configurar Juego</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="gameForm">
                    <input type="hidden" id="game-id">
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">TÍTULO</label>
                        <input type="text" id="titulo" class="form-control form-control-custom" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label text-secondary small fw-bold">PLATAFORMA</label>
                            <select id="plataforma" class="form-select form-control-custom">
                                <option value="PC">PC</option><option value="PS5">PlayStation 5</option>
                                <option value="XBOX">Xbox Series X</option><option value="SWITCH">Switch</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-secondary small fw-bold">PRECIO ($)</label>
                            <input type="number" id="precio" class="form-control form-control-custom" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">URL DE PORTADA</label>
                        <input type="text" id="imagen" class="form-control form-control-custom" placeholder="URL de la imagen">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-buy w-100 p-3 rounded-3" onclick="procesarFormulario()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end bg-dark border-start border-white border-opacity-10 text-white" tabindex="-1" id="cartPanel">
    <div class="offcanvas-header p-4 border-bottom border-white border-opacity-10">
        <h5 class="fw-bold mb-0">Carrito <i class="fa-solid fa-cart-shopping ms-2 text-info"></i></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-4 d-flex flex-column">
        <div id="cart-items-container" class="flex-grow-1 overflow-auto"></div>
        <div id="cart-footer" class="pt-4 border-top border-white border-opacity-10 d-none">
            <div class="d-flex justify-content-between h5 mb-4">
                <span>Total:</span>
                <span id="cart-total-amount" class="text-info fw-bold"></span>
            </div>
            <button class="btn btn-buy w-100 p-3 rounded-4 fw-bold" onclick="finalizarCompra()">VER RESUMEN</button>
        </div>
        <div id="cart-empty-msg" class="text-center text-secondary py-5">
            <i class="fa-solid fa-ghost display-4 mb-3 opacity-25"></i>
            <p>Tu carrito está vacío</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // --- CONFIGURACIÓN ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'gamevault-pro';
    const gamesPath = ['artifacts', appId, 'public', 'data', 'videojuegos'];
    const FALLBACK_IMG = "https://placehold.co/400x200/161c2d/ffffff?text=Imagen+No+Disponible";
    let firebaseConfig;
    try {
        // REEMPLAZA ESTO PARA PRODUCCIÓN EN NETLIFY
        firebaseConfig = {
            apiKey: "AIzaSyCPRM6wmQxaQ_BtznpXiZ7RuqpT88C6ZVE",
            authDomain: "tienda-gamer-1f0d9.firebaseapp.com",
            projectId: "tienda-gamer-1f0d9",
            storageBucket: "tienda-gamer-1f0d9.firebasestorage.app",
            messagingSenderId: "1079320179416",
            appId: "1:1079320179416:web:e381974c6a03ef5e11ddad",
            measurementId: "G-WK00XN3M6W"
        };
    } catch (e) {
        console.warn("Usando configuración manual de respaldo");
    }

   const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let productos = [];
    let cart = [];
    let unsubscribes = [];
    let currentView = "home";
    const modal = new bootstrap.Modal(document.getElementById('gameModal'));
    const offcanvasCart = new bootstrap.Offcanvas(document.getElementById('cartPanel'));

    // --- AUTENTICACIÓN ---
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) { console.error("Auth Error:", e); }
    };

    onAuthStateChanged(auth, (user) => {
        if (!user) { initAuth(); return; }
        
        unsubscribes.forEach(u => u());
        unsubscribes = [
            onSnapshot(collection(db, ...gamesPath), (snap) => {
                productos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log("Productos cargados:", productos); // Depuración en consola
                document.getElementById('loader').style.display = 'none';
                render();
                updateCartUI(); // Asegurar que el carrito se refresca si los productos cambian
            }, (err) => {
                console.error("Firestore Error:", err);
                document.getElementById('loader').style.display = 'none';
            })
        ];
    });

    window.imgError = (img) => {
        img.onerror = null;
        img.src = FALLBACK_IMG;
    };

    // --- LÓGICA DE TIENDA "SMART" ---
    // Esta función intenta obtener el valor de un campo aunque el nombre sea diferente en Firestore
    const getVal = (obj, keys, fallback = "") => {
        for(let key of keys) {
            if(obj[key] !== undefined && obj[key] !== null) return obj[key];
        }
        return fallback;
    };

    window.render = () => {
        const grid = document.getElementById('grid-productos');
        const adminBody = document.getElementById('admin-table-body');
        
        // Renderizado del GRID de la TIENDA
        grid.innerHTML = productos.map(p => {
            const tituloVal = getVal(p, ['titulo', 'title', 'nombre', 'name'], "Juego sin nombre");
            const imgUrlRaw = getVal(p, ['imagen', 'image', 'url', 'cover'], "");
            const imgUrl = (imgUrlRaw && imgUrlRaw.trim() !== "") ? imgUrlRaw : FALLBACK_IMG;
            const plataformaVal = getVal(p, ['plataforma', 'platform'], "N/A");
            const precioVal = p.precio !== undefined ? p.precio : "0.00";

            return `
                <div class="col">
                    <div class="game-card h-100 d-flex flex-column">
                        <div class="game-img-container">
                            <img src="${imgUrl}" 
                                 onerror="imgError(this)" 
                                 alt="${tituloVal}">
                            <span class="platform-badge text-white">${plataformaVal}</span>
                        </div>
                        <div class="card-body p-4 d-flex flex-column">
                            <h6 class="fw-bold text-white mb-1 text-truncate">${tituloVal}</h6>
                            <span class="text-info fw-bold mb-3">$${precioVal}</span>
                            <button onclick="addToCart('${p.id}')" class="btn btn-buy w-100 mt-auto">Añadir</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Renderizado de la TABLA de ADMIN
        adminBody.innerHTML = productos.map(p => {
            const tituloVal = getVal(p, ['titulo', 'title', 'nombre', 'name'], "Sin nombre");
            const imgUrlRaw = getVal(p, ['imagen', 'image', 'url', 'cover'], "");
            const imgUrl = (imgUrlRaw && imgUrlRaw.trim() !== "") ? imgUrlRaw : FALLBACK_IMG;
            const plataformaVal = getVal(p, ['plataforma', 'platform'], "N/A");
            const precioVal = p.precio !== undefined ? p.precio : "0.00";

            return `
                <tr class="border-bottom border-white border-opacity-5">
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <img src="${imgUrl}" 
                                 onerror="imgError(this)"
                                 class="rounded me-3" style="width: 40px; height: 25px; object-fit: cover;">
                            <span>${tituloVal}</span>
                        </div>
                    </td>
                    <td><span class="badge bg-dark border border-secondary">${plataformaVal}</span></td>
                    <td class="text-info">$${precioVal}</td>
                    <td class="text-end pe-4">
                        <button onclick="abrirModalEditar('${p.id}')" class="btn btn-link text-warning p-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="eliminarProducto('${p.id}')" class="btn btn-link text-danger p-1"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    };

    window.addToCart = (id) => {
        const p = productos.find(x => x.id === id);
        if (!p) return;
        const item = cart.find(c => c.id === id);
        if (item) item.cantidad++;
        else cart.push({...p, cantidad: 1});
        updateCartUI();
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Añadido', showConfirmButton: false, timer: 1000, background: '#161c2d', color: '#fff' });
    };

    window.updateQty = (index, delta) => {
        cart[index].cantidad += delta;
        if (cart[index].cantidad <= 0) cart.splice(index, 1);
        updateCartUI();
    };

    window.updateCartUI = () => {
        const count = cart.reduce((a, b) => a + b.cantidad, 0);
        document.getElementById('cart-counter').innerText = count;
        const total = cart.reduce((a, b) => {
            const precio = b.precio || 0;
            return a + (precio * b.cantidad);
        }, 0).toFixed(2);
        
        const footer = document.getElementById('cart-footer');
        const empty = document.getElementById('cart-empty-msg');
        const container = document.getElementById('cart-items-container');

        if (cart.length > 0) {
            footer.classList.remove('d-none'); empty.classList.add('d-none');
            document.getElementById('cart-total-amount').innerText = `$${total}`;
            container.innerHTML = cart.map((item, i) => {
                // USAR getVal AQUÍ TAMBIÉN PARA EL CARRITO
                const titulo = getVal(item, ['titulo', 'title', 'nombre', 'name'], "Juego");
                const precio = item.precio || 0;
                const imgUrlRaw = getVal(item, ['imagen', 'image', 'url', 'cover'], "");
                const imgUrl = (imgUrlRaw && imgUrlRaw.trim() !== "") ? imgUrlRaw : FALLBACK_IMG;

                return `
                <div class="mb-3 bg-white bg-opacity-5 p-3 rounded-4">
                    <div class="d-flex align-items-center mb-2">
                        <img src="${imgUrl}" onerror="imgError(this)" class="rounded me-3" style="width: 50px; height: 30px; object-fit: cover;">
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="d-flex justify-content-between">
                                <span class="small fw-bold text-truncate me-2">${titulo}</span>
                                <span class="text-info small fw-bold">$${(precio * item.cantidad).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                            <span class="px-2 small">${item.cantidad}</span>
                            <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                        </div>
                        <button class="btn btn-link text-danger p-0 small" onclick="updateQty(${i}, -${item.cantidad})">Eliminar</button>
                    </div>
                </div>
            `}).join('');
        } else {
            footer.classList.add('d-none'); empty.classList.remove('d-none'); container.innerHTML = '';
        }
    }

    // --- NAVEGACIÓN ---
    window.showHome = () => {
        currentView = "home";
        document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none');
        document.getElementById('view-normal').style.display = 'block';
        document.getElementById('profile-switcher-container').style.display = 'flex';
        document.getElementById('cart-btn-main').style.display = 'flex';
        updateNavUI();
    };

    window.finalizarCompra = () => {
        offcanvasCart.hide();
        currentView = "receipt";
        const total = cart.reduce((a, b) => a + ((b.precio || 0) * b.cantidad), 0).toFixed(2);
        document.getElementById('receipt-order-id').innerText = Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('receipt-total').innerText = `$${total}`;
        document.getElementById('receipt-items-list').innerHTML = cart.map(item => {
            const titulo = getVal(item, ['titulo', 'title', 'nombre', 'name'], "Juego");
            const precio = item.precio || 0;
            return `<tr><td>${titulo}</td><td class="text-center">x${item.cantidad}</td><td class="text-end">$${(precio * item.cantidad).toFixed(2)}</td></tr>`
        }).join('');
        
        document.getElementById('view-normal').style.display = 'none';
        document.getElementById('view-receipt').style.display = 'block';
        document.getElementById('profile-switcher-container').style.display = 'none';
        document.getElementById('cart-btn-main').style.display = 'none';
        updateNavUI();
    };

    window.showCheckout = () => {
        currentView = "checkout";
        document.getElementById('view-receipt').style.display = 'none';
        document.getElementById('view-checkout').style.display = 'block';
        updateNavUI();
    };

    window.handleGlobalBack = () => {
        if (currentView === "receipt") showHome();
        else if (currentView === "checkout") {
            currentView = "receipt";
            document.getElementById('view-checkout').style.display = 'none';
            document.getElementById('view-receipt').style.display = 'block';
        }
        updateNavUI();
    };

    function updateNavUI() {
        document.getElementById('global-back-btn').classList.toggle('disabled', currentView === 'home');
    }

    document.getElementById('checkoutForm').addEventListener('submit', (e) => {
        e.preventDefault();
        Swal.fire({ title: '¡Éxito!', text: 'Pedido procesado correctamente.', icon: 'success', background: '#161c2d', color: '#fff' })
            .then(() => { cart = []; updateCartUI(); showHome(); });
    });

    // --- ADMIN ---
    window.setProfile = (t) => {
        const admin = t === 'admin';
        document.getElementById('btn-user').classList.toggle('active', !admin);
        document.getElementById('btn-admin').classList.toggle('active', admin);
        document.getElementById('admin-panel').style.display = admin ? 'block' : 'none';
        document.getElementById('grid-productos').style.display = admin ? 'none' : 'flex';
        document.getElementById('admin-actions').classList.toggle('d-none', !admin);
    };

    window.abrirModalCrear = () => { 
        document.getElementById('gameForm').reset(); 
        document.getElementById('game-id').value = ''; 
        document.getElementById('modalTitle').innerText = 'Nuevo Juego';
        modal.show(); 
    };

    window.abrirModalEditar = (id) => {
        const p = productos.find(x => x.id === id);
        if (!p) return;
        document.getElementById('game-id').value = p.id;
        document.getElementById('titulo').value = getVal(p, ['titulo', 'title', 'nombre', 'name'], "");
        document.getElementById('plataforma').value = getVal(p, ['plataforma', 'platform'], "PC");
        document.getElementById('precio').value = p.precio || "";
        document.getElementById('imagen').value = getVal(p, ['imagen', 'image', 'url', 'cover'], "");
        document.getElementById('modalTitle').innerText = 'Editar Juego';
        modal.show();
    };

    window.procesarFormulario = async () => {
        const id = document.getElementById('game-id').value;
        const titulo = document.getElementById('titulo').value;
        const precio = parseFloat(document.getElementById('precio').value);

        if (!titulo || isNaN(precio)) {
            Swal.fire({ icon: 'error', title: 'Datos incompletos', text: 'Por favor rellene el título y el precio.', background: '#161c2d', color: '#fff' });
            return;
        }

        const data = {
            titulo: titulo,
            plataforma: document.getElementById('plataforma').value,
            precio: precio,
            imagen: document.getElementById('imagen').value || ""
        };

        try {
            if (id) {
                await updateDoc(doc(db, ...gamesPath, id), data);
            } else {
                await addDoc(collection(db, ...gamesPath), data);
            }
            modal.hide();
        } catch (error) { console.error("Error guardando:", error); }
    };

    window.eliminarProducto = async (id) => {
        const result = await Swal.fire({ 
            title: '¿Eliminar juego?', 
            text: "Esta acción no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true, 
            confirmButtonText: 'Sí, borrar',
            cancelButtonText: 'Cancelar',
            background: '#161c2d', 
            color: '#fff' 
        });

        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, ...gamesPath, id));
            } catch (error) { console.error("Error eliminando:", error); }
        }
    };
</script>
</body>
</html>