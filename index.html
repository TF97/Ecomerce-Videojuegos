<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameVault | Admin Panel & Cloud Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    
    <style>
        :root {
            --primary-neon: #00f2fe;
            --secondary-neon: #4facfe;
            --dark-bg: #050a1f; 
            --card-bg: #0a1435;
            --nav-bg: #08102b;
            --text-main: #e0e0e0;
        }

        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at top right, #081c4d 0%, var(--dark-bg) 70%);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(8, 16, 43, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--primary-neon);
            padding: 0.8rem 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-neon) !important;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 242, 254, 0.5);
        }

        .profile-switch {
            background: #1a2a5a;
            border-radius: 50px;
            padding: 5px;
            display: flex;
            gap: 5px;
        }

        .profile-btn {
            border: none;
            background: transparent;
            color: white;
            padding: 5px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .profile-btn.active {
            background: var(--primary-neon);
            color: #050a1f;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 242, 254, 0.4);
        }

        /* Admin CRUD Panel */
        #admin-panel {
            background: rgba(10, 20, 53, 0.8);
            border: 1px solid rgba(0, 242, 254, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 40px;
            display: none;
        }

        .table {
            color: var(--text-main);
            border-color: rgba(0, 242, 254, 0.1);
        }

        .table thead {
            background: rgba(0, 242, 254, 0.1);
            color: var(--primary-neon);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
        }

        /* Cards & UI Elements */
        .game-card {
            background: var(--card-bg);
            border: 1px solid rgba(0, 242, 254, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-neon);
        }

        .game-img-container {
            height: 160px;
            overflow: hidden;
        }

        .game-img-container img {
            width: 100%; height: 100%; object-fit: cover;
        }

        .btn-neon {
            background: linear-gradient(45deg, var(--primary-neon), var(--secondary-neon));
            color: #050a1f; font-weight: bold; border: none; border-radius: 50px;
            padding: 8px 20px;
        }

        .btn-neon:hover {
            box-shadow: 0 0 20px var(--primary-neon); color: #050a1f;
        }

        .cart-count {
            position: absolute; top: -5px; right: -5px;
            background: #ff4b5c; color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 0.7rem;
        }

        .offcanvas {
            background: var(--card-bg);
            border-left: 1px solid var(--primary-neon);
        }

        /* Modals */
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--primary-neon);
            color: white;
        }

        .form-control, .form-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0, 242, 254, 0.2);
            color: white;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: var(--primary-neon);
            box-shadow: 0 0 10px rgba(0, 242, 254, 0.2);
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-info mb-3" role="status"></div>
    <div class="font-orbitron text-info">AUTENTICANDO Y SINCRONIZANDO...</div>
</div>

<nav class="navbar navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-bolt me-2"></i>GAMEVAULT</a>
        <div class="d-flex align-items-center gap-3">
            <div class="profile-switch">
                <button id="btn-user" class="profile-btn active" onclick="setProfile('user')">Tienda</button>
                <button id="btn-admin" class="profile-btn" onclick="setProfile('admin')">Gestión</button>
            </div>
            <button class="btn btn-outline-info position-relative rounded-circle" data-bs-toggle="offcanvas" data-bs-target="#cartPanel" style="width: 42px; height: 42px;">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-counter" class="cart-count">0</span>
            </button>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <!-- Header dinámico -->
    <div class="row mb-4">
        <div class="col-12 text-center text-md-start">
            <h2 id="view-title" class="display-6 fw-bold font-orbitron text-info mb-1">CATÁLOGO</h2>
            <p id="view-desc" class="text-muted">Explora y adquiere los mejores títulos.</p>
        </div>
    </div>

    <!-- PANEL CRUD ADMIN -->
    <div id="admin-panel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="font-orbitron text-white mb-0"><i class="fas fa-tasks me-2"></i>Control de Inventario</h4>
            <button class="btn btn-neon" onclick="abrirModalCrear()">
                <i class="fas fa-plus me-2"></i>NUEVO JUEGO
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>PRODUCTO</th>
                        <th>PLATAFORMA</th>
                        <th>PRECIO</th>
                        <th class="text-end">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- VISTA CLIENTE -->
    <div id="grid-productos" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4 pb-5"></div>
</div>

<!-- Offcanvas Carrito -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel">
    <div class="offcanvas-header border-bottom border-info">
        <h5 class="font-orbitron text-info">CARRITO</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div id="cart-items-container"></div>
        <div id="cart-footer" class="mt-4 d-none">
            <hr class="bg-info">
            <div class="d-flex justify-content-between mb-3">
                <span>Total:</span>
                <span id="cart-total" class="h4 text-info">$0.00</span>
            </div>
            <button class="btn btn-neon w-100" onclick="finalizarCompra()">CONFIRMAR PEDIDO</button>
        </div>
    </div>
</div>

<!-- Modal CRUD -->
<div class="modal fade" id="gameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title font-orbitron text-info" id="modalTitle">GESTIÓN DE JUEGO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gameForm">
                    <input type="hidden" id="game-id">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Título del Juego</label>
                        <input type="text" id="titulo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Plataforma</label>
                        <select id="plataforma" class="form-select">
                            <option value="PC">PC Master Race</option>
                            <option value="PS5">PlayStation 5</option>
                            <option value="XBOX">Xbox Series X</option>
                            <option value="SWITCH">Nintendo Switch</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label small text-muted">Precio ($)</label>
                            <input type="number" id="precio" class="form-control" step="0.01" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">URL Portada</label>
                            <input type="text" id="imagen" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-neon w-100" onclick="procesarFormulario()">ACTUALIZAR NUBE</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // Global variables from environment
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'gamevault-pro';
    
    // Fixed Path following RULE 1
    const gamesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'videojuegos');

    let productos = [];
    let cart = [];
    let currentProfile = 'user';
    let currentUser = null;
    const modal = new bootstrap.Modal(document.getElementById('gameModal'));

    // --- RULE 3: Auth Before Queries ---
    const initApp = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth initialization failed:", error);
            Swal.fire({ title: 'Error de Conexión', text: 'No se pudo autenticar con el servidor.', icon: 'error', background: '#0a1435', color: '#fff' });
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loader').style.display = 'none';
            suscribirAData();
        } else {
            currentUser = null;
        }
    });

    // --- Firestore Operations with Safety Guards ---
    function suscribirAData() {
        if (!currentUser) return;

        // onSnapshot with success and error callbacks as required
        onSnapshot(gamesCollection, (snap) => {
            productos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        }, (error) => {
            console.error("Firestore Snapshot Error:", error);
            // Handle permission error or index error gracefully
            if (error.code === 'permission-denied') {
                console.warn("Retrying connection in 2s...");
                setTimeout(suscribirAData, 2000);
            }
        });
    }

    // --- UI Rendering ---
    window.render = function() {
        const grid = document.getElementById('grid-productos');
        const adminTable = document.getElementById('admin-table-body');

        if (!grid || !adminTable) return;

        grid.innerHTML = productos.map(p => `
            <div class="col">
                <div class="card game-card h-100">
                    <div class="game-img-container">
                        <img src="${p.imagen || 'https://via.placeholder.com/400x200?text=GAME'}" alt="${p.titulo}" onerror="this.src='https://via.placeholder.com/400x200?text=Error+Imagen'">
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold text-white mb-0">${p.titulo}</h6>
                            <span class="text-info fw-bold">$${p.precio}</span>
                        </div>
                        <small class="text-muted d-block mb-3"><i class="fas fa-gamepad me-1"></i>${p.plataforma}</small>
                        <button onclick="addToCart('${p.id}')" class="btn btn-outline-info btn-sm w-100 rounded-pill">Añadir al Carrito</button>
                    </div>
                </div>
            </div>
        `).join('');

        adminTable.innerHTML = productos.map(p => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${p.imagen}" class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/40x40?text=X'">
                        <span class="fw-bold text-truncate" style="max-width: 150px;">${p.titulo}</span>
                    </div>
                </td>
                <td><span class="badge bg-dark border border-info text-info">${p.plataforma}</span></td>
                <td class="fw-bold text-info">$${p.precio}</td>
                <td class="text-end">
                    <button onclick="abrirModalEditar('${p.id}')" class="btn btn-sm btn-outline-warning me-2"><i class="fas fa-edit"></i></button>
                    <button onclick="eliminarProducto('${p.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');

        updateCartUI();
    };

    window.setProfile = function(type) {
        currentProfile = type;
        const isAdmin = type === 'admin';
        document.getElementById('btn-user').classList.toggle('active', !isAdmin);
        document.getElementById('btn-admin').classList.toggle('active', isAdmin);
        document.getElementById('admin-panel').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('grid-productos').style.display = isAdmin ? 'none' : 'flex';
        document.getElementById('view-title').innerText = isAdmin ? 'PANEL DE GESTIÓN' : 'CATÁLOGO';
        document.getElementById('view-desc').innerText = isAdmin ? 'Administra el inventario global.' : 'Explora los mejores títulos.';
        render();
    };

    // --- Admin CRUD Actions ---
    window.abrirModalCrear = () => {
        document.getElementById('gameForm').reset();
        document.getElementById('game-id').value = '';
        document.getElementById('modalTitle').innerText = 'CREAR NUEVO JUEGO';
        modal.show();
    };

    window.abrirModalEditar = (id) => {
        const p = productos.find(x => x.id === id);
        if (!p) return;
        document.getElementById('game-id').value = p.id;
        document.getElementById('titulo').value = p.titulo;
        document.getElementById('plataforma').value = p.plataforma;
        document.getElementById('precio').value = p.precio;
        document.getElementById('imagen').value = p.imagen;
        document.getElementById('modalTitle').innerText = 'EDITAR PRODUCTO';
        modal.show();
    };

    window.procesarFormulario = async () => {
        if (!currentUser) return;
        const id = document.getElementById('game-id').value;
        const datos = {
            titulo: document.getElementById('titulo').value,
            plataforma: document.getElementById('plataforma').value,
            precio: parseFloat(document.getElementById('precio').value) || 0,
            imagen: document.getElementById('imagen').value || 'https://via.placeholder.com/400x200?text=GAME'
        };

        try {
            if (id) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'videojuegos', id), datos);
            } else {
                await addDoc(gamesCollection, datos);
            }
            modal.hide();
            Swal.fire({ title: 'Éxito', icon: 'success', background: '#0a1435', color: '#fff', timer: 1500 });
        } catch (e) {
            console.error("Operation failed:", e);
            Swal.fire({ title: 'Error', text: 'No tienes permisos para esta acción.', icon: 'error', background: '#0a1435', color: '#fff' });
        }
    };

    window.eliminarProducto = async (id) => {
        if (!currentUser) return;
        const res = await Swal.fire({
            title: '¿Eliminar producto?',
            text: "Se borrará permanentemente de la nube.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff4b5c',
            cancelButtonColor: '#00f2fe',
            background: '#0a1435', color: '#fff'
        });

        if (res.isConfirmed) {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'videojuegos', id));
            } catch (e) { console.error(e); }
        }
    };

    // --- Cart Logic ---
    window.addToCart = (id) => {
        const item = productos.find(p => p.id === id);
        if (!item) return;
        const inCart = cart.find(c => c.id === id);
        if (inCart) inCart.qty++;
        else cart.push({ ...item, qty: 1 });
        updateCartUI();
    };

    window.updateCartUI = () => {
        const container = document.getElementById('cart-items-container');
        const counter = document.getElementById('cart-counter');
        const footer = document.getElementById('cart-footer');
        if (!container) return;

        counter.innerText = cart.reduce((a, b) => a + b.qty, 0);
        
        if (cart.length === 0) {
            container.innerHTML = '<div class="text-center py-5 text-muted small">Tu carrito está vacío</div>';
            footer.classList.add('d-none');
        } else {
            container.innerHTML = cart.map(item => `
                <div class="d-flex align-items-center mb-3 p-2 rounded" style="background: rgba(255,255,255,0.05)">
                    <img src="${item.imagen}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/40x40?text=X'">
                    <div class="ms-3 flex-grow-1">
                        <div class="small fw-bold text-white">${item.titulo}</div>
                        <div class="text-info" style="font-size: 0.75rem">$${item.precio} x ${item.qty}</div>
                    </div>
                    <button onclick="removeFromCart('${item.id}')" class="btn btn-sm text-danger"><i class="fas fa-trash-alt"></i></button>
                </div>
            `).join('');
            const total = cart.reduce((a, b) => a + (b.precio * b.qty), 0);
            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
            footer.classList.remove('d-none');
        }
    };

    window.removeFromCart = (id) => {
        cart = cart.filter(c => c.id !== id);
        updateCartUI();
    };

    window.finalizarCompra = () => {
        Swal.fire({ title: '¡Pedido Realizado!', text: 'Gracias por confiar en GameVault.', icon: 'success', background: '#0a1435', color: '#fff' });
        cart = [];
        updateCartUI();
    };

    // Initialize Auth on Load
    initApp();
</script>
</body>
</html>